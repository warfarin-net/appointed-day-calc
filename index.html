<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointed day calc</title>
    <!-- ‡πÉ‡∏ä‡πâ Tailwind CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞ Responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ‡πÉ‡∏ä‡πâ Google Fonts: Google Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:ital,opsz,wght@0,17..18,400..700;1,17..18,400..700&display=swap" rel="stylesheet">
    <!-- Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">

    <link rel="manifest" href="site.webmanifest">
    <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="android-chrome-192x192.png">

    <style>
        body {
            font-family: 'Google Sans', sans-serif;
            background-color: #f3f4f6;
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto !important; 
            overflow-x: auto !important; /* ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏î‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        }
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb { background: #c7c7cc; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #a1a1aa; }
        
        /* Checkbox styling for specific days */
        .day-checkbox:checked + label {
            background-color: #3C79F5;
            color: white;
            border-color: #3C79F5;
        }

        /* Modal Animation */
        .modal {
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        body.modal-active {
            overflow-x: hidden;
            overflow-y: visible !important;
        }

        /* Save Icon Animation */
        @keyframes fade-blink {
            0%, 100% { opacity: 0; transform: scale(0.9); }
            10%, 90% { opacity: 1; transform: scale(1); }
            50% { color: #16a34a; }
        }
        .saving-active {
            animation: fade-blink 1.5s ease-in-out forwards;
        }

        /* Tab Transition */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .tab-content.active {
            display: flex; 
            flex-direction: column;
            gap: 1.5rem; 
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Active Edit Day Animation */
        @keyframes ring-pulse {
            0% { box-shadow: 0 0 0 2px #1E293B; }
            50% { box-shadow: 0 0 0 6px rgba(30, 41, 59, 0.25); }
            100% { box-shadow: 0 0 0 2px #1E293B; }
        }
        .active-ring-pulse {
            animation: ring-pulse 1.5s infinite;
            border-color: #1E293B !important;
            background-color: #F8FAFC !important; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô ‡∏™‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤ ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏™‡∏µ‡∏ß‡∏±‡∏ô */
        }
    </style>
</head>
<body class="min-h-screen py-4 sm:py-6 px-2 sm:px-4 bg-slate-100 flex flex-col items-center gap-4 sm:gap-6 overflow-x-hidden">

    <!-- Confirmation Modal -->
    <div id="clearHistoryModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[60]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold text-gray-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</p>
                    <div class="modal-close cursor-pointer z-50" onclick="toggleModal()">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                            <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                        </svg>
                    </div>
                </div>
                <p class="text-gray-600">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                <div class="flex justify-end pt-4 gap-2">
                    <button onclick="toggleModal()" class="px-4 py-2 bg-gray-200 p-3 rounded-lg text-black hover:bg-gray-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button onclick="performClearHistory()" class="px-4 py-2 bg-red-600 p-3 rounded-lg text-white hover:bg-red-700">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB NAVIGATION -->
    <div class="w-full max-w-4xl bg-white rounded-xl shadow-sm p-1.5 flex gap-1.5 sticky top-2 z-40 border border-gray-200">
        <!-- Forward Tab -->
        <button onclick="switchTab('forward')" id="tab-btn-forward" class="flex-1 py-2 sm:py-3 rounded-lg text-xs sm:text-sm font-bold transition-all duration-200 flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 bg-[#3C79F5] text-white shadow-md">
            <i class="fas fa-pills text-sm sm:text-base"></i> <span class="leading-tight text-center">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤</span>
        </button>
        <!-- Reverse Tab -->
        <button onclick="switchTab('reverse')" id="tab-btn-reverse" class="relative flex-1 py-2 sm:py-3 rounded-lg text-xs sm:text-sm font-bold transition-all duration-200 flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 text-gray-500 hover:bg-gray-50">
            <span class="absolute top-0.5 left-1 text-[8px] sm:text-[9px] bg-yellow-100 text-yellow-800 px-1 py-0.5 rounded leading-none hidden sm:block">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</span>
            <i class="fas fa-calendar-alt text-sm sm:text-base"></i> <span class="leading-tight text-center">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î<span class="hidden sm:inline">‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤</span></span>
        </button>
    </div>

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î -->
    <div id="tab-content-forward" class="tab-content active w-full max-w-4xl">
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden relative">
            <!-- Header Background: #3C79F5 -->
            <div class="bg-[#3C79F5] p-4 sm:p-6 text-center relative">
                <h1 class="text-xl sm:text-2xl font-bold text-white">üíä ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î</h1>
                <p class="text-white/90 text-xs sm:text-sm mt-1">‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î</p>
            </div>

            <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">
                <div class="bg-gray-50 p-3 sm:p-4 rounded-xl border border-gray-100">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                        <div>
                            <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏° (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</label>
                            <input type="date" id="startDate" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3C79F5] outline-none bg-white text-center text-sm sm:text-base" onchange="calculateMeds(); updateDurationPreview();">
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</label>
                            <input type="date" id="endDate" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#3C79F5] outline-none bg-white text-center text-sm sm:text-base" onchange="calculateMeds(); updateDurationPreview();">
                        </div>
                    </div>
                    
                    <div class="mt-3 flex justify-center items-center gap-2">
                        <input type="checkbox" id="includeEndDate" class="w-4 h-4 text-[#3C79F5] rounded focus:ring-[#3C79F5]" onchange="calculateMeds(); updateDurationPreview();">
                        <label for="includeEndDate" class="text-xs sm:text-sm text-gray-600 cursor-pointer italic">‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏¢‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏î‡πâ‡∏ß‡∏¢</label>
                    </div>
                    
                    <div class="mt-4 pt-3 border-t border-gray-200 flex flex-col sm:flex-row justify-between items-center gap-3">
                        <div id="durationPreview" class="text-base sm:text-lg font-medium text-[#3C79F5] min-h-[1.75rem] flex items-center justify-center gap-2"></div>
                        <button onclick="resetForward()" class="text-gray-400 hover:text-red-500 flex items-center gap-1.5 text-xs sm:text-sm font-medium px-3 py-1.5 rounded-lg hover:bg-red-50 transition-all" title="‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà (Reset)">
                            <i class="fas fa-redo-alt"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-3 pl-1">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏¢‡∏≤‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏¢‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)</label>
                    
                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô (7 ‡∏ß‡∏±‡∏ô) -->
                    <div id="daysList" class="grid grid-cols-4 sm:grid-cols-7 gap-1.5 sm:gap-2 mb-4">
                        <!-- Days Cards Generated by JS -->
                    </div>

                    <!-- ‡πÅ‡∏ú‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏£‡∏ß‡∏° (Shared Options Panel) ‡∏à‡∏±‡∏î 2 ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏ö‡∏ö Flex Center -->
                    <div id="sharedOptionsPanel" class="hidden bg-blue-50 border border-blue-200 rounded-xl p-2.5 sm:p-4 animate-fade-in relative shadow-inner mx-auto max-w-2xl mt-2">
                        <div class="flex justify-between items-center mb-2.5">
                            <span class="text-xs sm:text-sm font-bold text-gray-700" id="sharedOptionsTitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏¢‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö...</span>
                            <button onclick="closeSharedOptions()" class="text-gray-400 hover:text-red-500 bg-white rounded-full w-6 h-6 flex items-center justify-center shadow-sm">
                                <i class="fas fa-times text-xs"></i>
                            </button>
                        </div>
                        <!-- ‡πÉ‡∏ä‡πâ Flex-wrap ‡πÅ‡∏•‡∏∞ justify-center ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡πà‡∏á 7 ‡πÅ‡∏•‡∏∞ 6 ‡∏ï‡∏±‡∏ß‡∏û‡∏≠‡∏î‡∏µ -->
                        <div class="flex flex-wrap justify-center gap-1.5 sm:gap-2" id="sharedOptionsGrid">
                            <!-- Options Generated by JS -->
                        </div>
                        
                        <!-- ‡∏õ‡∏∏‡πà‡∏° ‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô (‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Å‡πá‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡πâ‡∏ß) -->
                        <div id="applyAllContainer" class="mt-3 pt-3 border-t border-blue-200/60 flex justify-center hidden animate-fade-in">
                            <button onclick="applyToAllDays()" class="text-xs sm:text-sm bg-white border-2 border-[#3C79F5]/40 text-[#3C79F5] hover:bg-[#3C79F5] hover:border-[#3C79F5] hover:text-white font-bold py-1.5 sm:py-2 px-4 sm:px-6 rounded-xl flex items-center gap-2 transition-all shadow-sm active:scale-95">
                                <i class="fas fa-copy"></i> ‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô (<span id="applyAllValue"></span>)
                            </button>
                        </div>
                    </div>
                </div>

                <div id="resultArea" class="hidden animate-fade-in relative group mt-4 sm:mt-6">
                    <div class="bg-green-50 border-2 border-green-100 rounded-xl p-4 sm:p-6 text-center shadow-sm relative">
                        <!-- Save Status Indicator -->
                        <div id="saveStatus1" class="absolute top-2 right-2 text-green-500 text-[10px] sm:text-xs font-bold opacity-0 flex items-center gap-1 pointer-events-none">
                            <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß
                        </div>

                        <p class="text-gray-600 font-medium mb-1 text-sm sm:text-base">‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                        <div class="text-4xl sm:text-5xl font-bold text-green-700 mb-3">
                            <span id="totalPills">0</span> <span class="text-xl sm:text-2xl font-normal text-green-600">‡πÄ‡∏°‡πá‡∏î/‡πÅ‡∏Ñ‡∏õ‡∏ã‡∏π‡∏•</span>
                        </div>
                        <div class="inline-block bg-white px-3 sm:px-4 py-1 sm:py-1.5 rounded-full border border-green-200 shadow-sm">
                            <p class="text-xs sm:text-sm text-gray-600 font-medium" id="durationText">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ 0 ‡∏ß‡∏±‡∏ô</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: Memory Note (History) -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden border-t-8 border-gray-500">
            <div class="bg-gray-700 p-3 sm:p-4 text-white flex justify-between items-center">
                <h1 class="text-base sm:text-lg font-bold"><i class="fas fa-history mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥ (7 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h1>
                <button type="button" onclick="toggleModal()" class="text-xs bg-gray-600 hover:bg-red-500 text-white px-2.5 sm:px-3 py-1 sm:py-1.5 rounded transition shadow">‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            </div>
            <div class="p-3 sm:p-4 bg-gray-50">
                <ul id="historyList" class="space-y-2">
                    <li class="text-center text-gray-400 text-xs sm:text-sm py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡∏ö‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö -->
    <div id="tab-content-reverse" class="tab-content w-full max-w-4xl">
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden border-t-8 border-[#FDD771] relative">
            <div class="bg-[#FDD771] p-4 sm:p-6 text-center text-slate-800 relative">
                <!-- Badge -->
                <span class="absolute top-3 left-3 text-[11px] bg-white/60 px-2 py-1 rounded-md text-slate-900 font-medium tracking-wide">
                    ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                </span>
                
                <h1 class="text-xl sm:text-2xl font-bold mt-1 sm:mt-2">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î - ‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</h1>
                <p class="text-slate-700 text-xs sm:text-sm mt-1">
                    ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏à‡∏∞‡∏´‡∏°‡∏î <br>
                    <span class="text-[9px] sm:text-[10px] opacity-80">(* ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô)</span>
                </p>
            </div>

            <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">
                <!-- Main Input Section -->
                <div class="bg-[#FDD771]/10 p-4 sm:p-6 rounded-xl border border-[#FDD771]/30 shadow-sm relative">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6 items-end">
                        <div>
                            <label class="block text-xs sm:text-sm font-semibold text-slate-700 mb-1.5 sm:mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏¢‡∏≤</label>
                            <input type="date" id="reverseStartDate" class="w-full p-2.5 sm:p-3 border-2 border-[#FDD771]/50 rounded-xl focus:ring-2 focus:ring-[#FDD771] outline-none bg-white text-center text-base sm:text-lg font-medium shadow-sm" onchange="calculateAllReverse()">
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-semibold text-slate-700 mb-1.5 sm:mb-2">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤ (‡πÄ‡∏°‡πá‡∏î/‡πÅ‡∏Ñ‡∏õ‡∏ã‡∏π‡∏•)</label>
                            <input type="number" id="reversePillsInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô 100" class="w-full text-center text-xl sm:text-2xl font-bold p-2.5 sm:p-3 border-2 border-[#FDD771]/50 rounded-xl focus:ring-4 focus:ring-[#FDD771]/50 outline-none transition shadow-inner bg-white" oninput="calculateAllReverse()">
                        </div>
                    </div>
                    
                    <div class="mt-4 sm:mt-5 pt-3 sm:pt-4 border-t border-yellow-200/60 flex justify-end">
                        <button onclick="resetReverse()" class="text-yellow-700 hover:text-red-600 flex items-center gap-1.5 text-xs sm:text-sm font-medium px-3 py-1.5 rounded-lg hover:bg-red-50 transition-all" title="‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà (Reset)">
                            <i class="fas fa-redo-alt"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                    </div>
                </div>

                <!-- Custom Calculation Section -->
                <div class="bg-white border-2 border-dashed border-[#FDD771] p-4 sm:p-5 rounded-xl">
                    <h3 class="text-base sm:text-lg font-bold text-slate-700 mb-3 sm:mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5 text-yellow-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                        ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á (Custom)
                    </h3>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4 mb-3 sm:mb-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤/‡∏°‡∏∑‡πâ‡∏≠</label>
                            <input type="number" id="customPerDose" step="0.25" min="0.25" value="1" class="w-full p-2 border border-gray-300 rounded-lg text-center font-bold text-slate-700 focus:border-[#FDD771] focus:ring-1 focus:ring-[#FDD771]" oninput="calculateCustom()" onchange="validateDosageInput(this)">
                            <p class="text-[9px] sm:text-[10px] text-gray-400 mt-1 text-center">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏î ‡∏ó‡∏µ‡∏•‡∏∞ 1/4 (0.25)</p>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏∑‡πâ‡∏≠/‡∏ß‡∏±‡∏ô</label>
                            <input type="number" id="customTimes" value="1" class="w-full p-2 border border-gray-300 rounded-lg text-center font-bold text-slate-700 focus:border-[#FDD771] focus:ring-1 focus:ring-[#FDD771]" oninput="calculateCustom()">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</label>
                            <select id="customFreq" class="w-full p-2 border border-gray-300 rounded-lg text-xs sm:text-sm bg-white focus:border-[#FDD771] focus:ring-1 focus:ring-[#FDD771]" onchange="toggleWeekDays(); calculateCustom()">
                                <option value="daily">‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô (Everyday)</option>
                                <option value="eod">‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏±‡∏ô (EOD)</option>
                                <option value="specific">‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                            </select>
                        </div>
                    </div>

                    <!-- Specific Days Selector -->
                    <div id="weekDaysSelector" class="hidden mb-3 sm:mb-4 p-2 sm:p-3 bg-gray-50 rounded-lg border border-gray-100">
                        <p class="text-xs text-gray-500 mb-2 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤:</p>
                        <div class="flex flex-wrap justify-center gap-1.5 sm:gap-2">
                            <!-- Days generated by JS -->
                        </div>
                    </div>

                    <!-- Custom Result Display -->
                    <div id="customResult" class="bg-[#FDD771]/20 rounded-lg p-3 sm:p-4 text-center hidden relative">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                            <div class="bg-white rounded-lg p-2 shadow-sm border border-[#FDD771]/30">
                                 <span class="text-[10px] sm:text-xs text-gray-500 block mb-1">‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏°‡∏∑‡πâ‡∏≠‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
                                 <div class="font-bold text-lg sm:text-xl text-gray-700" id="customLastDoseDate">-</div>
                                 <div class="text-[10px] sm:text-xs text-gray-400 mt-1" id="durationToLastDose">-</div>
                            </div>
                            <div class="bg-white rounded-lg p-2 shadow-sm border border-[#FDD771]/30">
                                 <span class="text-[10px] sm:text-xs text-yellow-700 block mb-1 font-bold">‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
                                 <div class="font-bold text-lg sm:text-xl text-yellow-800" id="customEndDate">-</div>
                                 <div class="text-[10px] sm:text-xs text-yellow-600 mt-1" id="durationToAppointment">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Standard Table Section (‡∏°‡∏µ overflow-x-auto) -->
                <div class="border border-gray-200 rounded-xl shadow-sm table-container bg-white w-full">
                    <table class="w-full text-left border-collapse min-w-[450px]">
                        <thead class="bg-gray-100 border-b border-gray-200 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="p-2 sm:p-3 text-xs sm:text-sm font-bold text-gray-600 uppercase w-5/12">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏¢‡∏≤</th>
                                <th class="p-2 sm:p-3 text-xs sm:text-sm font-bold text-gray-600 uppercase text-center w-3/12">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ß‡∏±‡∏ô)</th>
                                <th class="p-2 sm:p-3 text-xs sm:text-sm font-bold text-gray-600 uppercase text-center w-4/12 text-yellow-700">‡∏ß‡∏±‡∏ô‡∏¢‡∏≤‡∏´‡∏°‡∏î (‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î)</th>
                            </tr>
                        </thead>
                        <tbody id="reverseResultBody" class="divide-y divide-gray-100">
                            <tr>
                                <td colspan="3" class="p-6 sm:p-8 text-center text-gray-400 text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Visitor Counter ‡πÅ‡∏ö‡∏ö Firebase Real-time -->
    <footer class="text-center text-gray-500 mt-6 mb-8 flex flex-col items-center">
        <p class="mb-2 text-xs sm:text-sm font-medium">‡∏¢‡∏≠‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏∞‡∏™‡∏°</p>
        <div class="inline-flex items-center gap-2.5 py-2 px-4 bg-white rounded-full shadow-sm border border-gray-200">
            <div class="bg-blue-100 text-[#3C79F5] w-6 h-6 rounded-full flex items-center justify-center shrink-0">
                <i class="fas fa-eye text-xs"></i>
            </div>
            <div class="flex items-baseline gap-1">
                <span id="visitorCountText" class="font-bold text-lg text-gray-700 leading-none">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                <span class="text-gray-500 text-[11px] sm:text-xs">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
            </div>
        </div>
    </footer>

<!-- Firebase SDK (‡πÉ‡∏ä‡πâ Type Module ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡∏ô‡∏Å‡∏±‡∏ö‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÄ‡∏Å‡πà‡∏≤) -->
<script type="module">
    // ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≤‡∏Å Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ‚ö†Ô∏è ‡∏ô‡∏≥ firebaseConfig ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏±‡∏ö‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚ö†Ô∏è
    const firebaseConfig = {
        apiKey: "AIzaSyBapwTW8Huf7zcmetKRkIyNU86txcmAGmw",
        authDomain: "appointed-day-calc.firebaseapp.com",
        projectId: "appointed-day-calc",
        storageBucket: "appointed-day-calc.firebasestorage.app",
        messagingSenderId: "101497292557",
        appId: "1:101497292557:web:1cdd788465d21809d4d244",
        measurementId: "G-Y9QCJKEKJP"
    };

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Document) ‡∏ä‡∏∑‡πà‡∏≠ 'visitors' ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á 'statistics'
    const counterRef = doc(db, "statistics", "visitors");

    async function updateAndFetchCounter() {
        try {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Session ‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡∏ô‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏î Refresh)
            const hasVisited = sessionStorage.getItem('hasVisited_Firebase');

            if (!hasVisited) {
                // ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ô‡∏±‡∏ö -> ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏¢‡∏≠‡∏î + 1 (‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
                await setDoc(counterRef, { count: increment(1) }, { merge: true });
                sessionStorage.setItem('hasVisited_Firebase', 'true');
            }

            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            const docSnap = await getDoc(counterRef);
            if (docSnap.exists()) {
                document.getElementById('visitorCountText').innerText = docSnap.data().count.toLocaleString();
            } else {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ (‡∏û‡∏∂‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)
                document.getElementById('visitorCountText').innerText = "1";
            }
        } catch (error) {
            console.error("Firebase Error:", error);
            document.getElementById('visitorCountText').innerText = "Error";
        }
    }

    // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°
    updateAndFetchCounter();
</script>

<script>
    // Global variables
    let forwardSaveTimeout;
    const AUTO_SAVE_DELAY = 2000; // 2 seconds

    // --- State for Section 1 (Forward Calc) ---
    let activeEditDay = null; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏≠‡∏î‡∏µ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    let selectedDosages = {
        0: "-", 1: "-", 2: "-", 3: "-", 4: "-", 5: "-", 6: "-"
    };

    const dosageOptions = ["-", "1/4", "1/2", "3/4", "1", "1.5", "2", "2.5", "3", "3.5", "4", "4.5", "5"];

    // Tabs Logic
    function switchTab(tab) {
        const baseClass = "flex-1 py-2 sm:py-3 rounded-lg text-xs sm:text-sm font-bold transition-all duration-200 flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2";
        const inactiveClass = baseClass + " text-gray-500 hover:bg-gray-50";
        
        document.getElementById('tab-btn-forward').className = inactiveClass;
        document.getElementById('tab-btn-reverse').className = "relative " + inactiveClass;
        
        document.getElementById('tab-content-forward').classList.remove('active');
        document.getElementById('tab-content-reverse').classList.remove('active');

        if (tab === 'forward') {
            document.getElementById('tab-btn-forward').className = baseClass + " bg-[#3C79F5] text-white shadow-md";
            document.getElementById('tab-content-forward').classList.add('active');
        } else {
            document.getElementById('tab-btn-reverse').className = "relative " + baseClass + " bg-[#FDD771] text-slate-800 shadow-md";
            document.getElementById('tab-content-reverse').classList.add('active');
        }
    }

    // --- PART 1: Forward Calculation ---
    // Update Array for Short names on Mobile
    const daysOfWeek = [
        { id: 0, name: "‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå", short: "‡∏≠‡∏≤.", color: "text-red-700", border: "border-red-500" },
        { id: 1, name: "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", short: "‡∏à.", color: "text-yellow-700", border: "border-yellow-400" },
        { id: 2, name: "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", short: "‡∏≠.", color: "text-pink-700", border: "border-pink-500" },
        { id: 3, name: "‡∏û‡∏∏‡∏ò", short: "‡∏û.", color: "text-green-700", border: "border-green-500" },
        { id: 4, name: "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ", short: "‡∏û‡∏§.", color: "text-orange-700", border: "border-orange-500" },
        { id: 5, name: "‡∏®‡∏∏‡∏Å‡∏£‡πå", short: "‡∏®.", color: "text-blue-700", border: "border-blue-500" },
        { id: 6, name: "‡πÄ‡∏™‡∏≤‡∏£‡πå", short: "‡∏™.", color: "text-purple-700", border: "border-purple-500" }
    ];

    window.onload = function() {
        const today = new Date().toISOString().split('T')[0];
        
        resetForward();
        resetReverse();
        
        renderWeekDaysSelector();
        loadHistory();
        
        switchTab('forward');
    };

    // --- Shared Options Panel Logic ---
    function selectEditDay(dayId) {
        if (activeEditDay === dayId) {
            activeEditDay = null; // ‡∏õ‡∏¥‡∏î‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
        } else {
            activeEditDay = dayId; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
        }
        renderDayList();
        renderSharedOptions();
    }

    function closeSharedOptions() {
        activeEditDay = null;
        renderDayList();
        renderSharedOptions();
    }

    function selectSharedDosage(opt) {
        if (activeEditDay === null) return;
        
        selectedDosages[activeEditDay] = opt;
        
        renderDayList();
        renderSharedOptions(); 
        calculateMeds();
    }

    function renderDayList() {
        const container = document.getElementById('daysList');
        let html = '';
        
        // ‡∏ä‡∏∏‡∏î‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô (‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏™‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
        const colorPalette = [
            { main: 'bg-[#3C79F5] border-[#3C79F5]', bg: 'bg-blue-50/50 ring-[#3C79F5]/30' },
            { main: 'bg-teal-500 border-teal-500', bg: 'bg-teal-50/50 ring-teal-500/30' },
            { main: 'bg-purple-500 border-purple-500', bg: 'bg-purple-50/50 ring-purple-500/30' },
            { main: 'bg-orange-500 border-orange-500', bg: 'bg-orange-50/50 ring-orange-500/30' },
            { main: 'bg-pink-500 border-pink-500', bg: 'bg-pink-50/50 ring-pink-500/30' },
            { main: 'bg-emerald-500 border-emerald-500', bg: 'bg-emerald-50/50 ring-emerald-500/30' }
        ];

        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ï‡∏±‡∏î‡∏Ñ‡πà‡∏≤ "-" ‡∏≠‡∏≠‡∏Å) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏µ
        let uniqueVals = [...new Set(Object.values(selectedDosages))].filter(v => v !== "-");
        let valueColorMap = {};
        uniqueVals.forEach((val, index) => {
            valueColorMap[val] = colorPalette[index % colorPalette.length];
        });
        
        daysOfWeek.forEach(day => {
            const currentVal = selectedDosages[day.id];
            const hasValue = currentVal !== "-";
            const isEditing = activeEditDay === day.id;
            
            // ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏Ñ‡∏•‡∏≤‡∏™‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö active-ring-pulse)
            const baseBg = isEditing ? 'active-ring-pulse shadow-md scale-105 z-10' : 'hover:shadow-md shadow-sm border-gray-100';
            
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            let colorBg = 'bg-white';
            let displayBg = 'bg-gray-50 text-gray-400 border-gray-200';

            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏¢‡∏≤ ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏ä‡∏∏‡∏î‡∏™‡∏µ‡∏à‡∏≤‡∏Å Map
            if (hasValue) {
                const palette = valueColorMap[currentVal];
                displayBg = `${palette.main} text-white`;
                if (!isEditing) {
                    colorBg = `${palette.bg} ring-1`;
                }
            }

            html += `
                <div onclick="selectEditDay(${day.id})" class="w-full rounded-xl border-t-4 ${day.border} border-x border-b ${baseBg} ${colorBg} p-1.5 sm:p-3 flex flex-col items-center justify-center space-y-1 sm:space-y-2 cursor-pointer transition-all transform select-none relative">
                    ${isEditing ? '<div class="absolute -top-1.5 -right-1.5 w-3.5 h-3.5 bg-[#1E293B] rounded-full border-2 border-white animate-bounce shadow-sm z-20"></div>' : ''}
                    <span class="font-bold text-xs sm:text-sm ${day.color} hidden sm:block">${day.name}</span>
                    <span class="font-bold text-[11px] ${day.color} sm:hidden">${day.short}</span>
                    <span class="text-sm sm:text-lg font-bold w-full text-center rounded-lg py-0.5 sm:py-1 border transition-colors ${displayBg}">${currentVal}</span>
                </div>`;
        });
        container.innerHTML = html;
    }

    function renderSharedOptions() {
        const panel = document.getElementById('sharedOptionsPanel');
        const grid = document.getElementById('sharedOptionsGrid');
        const title = document.getElementById('sharedOptionsTitle');
        const applyAllContainer = document.getElementById('applyAllContainer');
        const applyAllValue = document.getElementById('applyAllValue');

        if (activeEditDay === null) {
            panel.classList.add('hidden');
            return;
        }

        panel.classList.remove('hidden');
        const dayInfo = daysOfWeek.find(d => d.id === activeEditDay);
        title.innerHTML = `‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏¢‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <span class="${dayInfo.color} font-bold text-sm sm:text-base ml-1">‡∏ß‡∏±‡∏ô${dayInfo.name}</span>`;

        const currentVal = selectedDosages[activeEditDay];
        let html = '';
        dosageOptions.forEach(opt => {
            const isSelected = currentVal === opt;
            const optBg = isSelected 
                ? 'bg-[#3C79F5] text-white shadow-sm ring-1 ring-[#3C79F5] ring-offset-1' 
                : 'bg-white text-gray-700 hover:bg-blue-50 hover:text-[#3C79F5] border border-gray-200';
            
            // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á w-10 (40px) ‡∏ñ‡∏∂‡∏á w-14 (56px) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 13 ‡∏≠‡∏±‡∏ô ‡∏à‡∏±‡∏î‡πÑ‡∏î‡πâ 7 ‡∏ï‡∏±‡∏ß‡∏ï‡πà‡∏≠ 1 ‡πÅ‡∏ñ‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏û‡∏≠‡∏î‡∏µ
            html += `<button onclick="selectSharedDosage('${opt}')" class="w-[12%] min-w-[40px] sm:min-w-[48px] md:min-w-[56px] py-1.5 sm:py-2 rounded-md text-xs sm:text-sm font-bold transition-all active:scale-95 flex items-center justify-center ${optBg}">${opt}</button>`;
        });
        grid.innerHTML = html;

        // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° "‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô" ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "-"
        if (currentVal !== "-") {
            applyAllContainer.classList.remove('hidden');
            applyAllContainer.classList.add('flex');
            applyAllValue.innerText = currentVal;
        } else {
            applyAllContainer.classList.add('hidden');
            applyAllContainer.classList.remove('flex');
        }
    }

    function applyToAllDays() {
        if (activeEditDay === null) return;
        const currentVal = selectedDosages[activeEditDay];
        
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡πÜ ‡∏ß‡∏±‡∏ô
        Object.keys(selectedDosages).forEach(key => {
            selectedDosages[key] = currentVal;
        });
        
        renderDayList();
        calculateMeds();
        closeSharedOptions(); // ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à
    }

    function parseDosage(value) {
        if (value === "-") return 0;
        if (value === "1/4") return 0.25;
        if (value === "1/2") return 0.5;
        if (value === "3/4") return 0.75;
        return parseFloat(value);
    }

    function updateDurationPreview() {
        const startVal = document.getElementById('startDate').value;
        const endVal = document.getElementById('endDate').value;
        const includeDay = document.getElementById('includeEndDate').checked;
        const display = document.getElementById('durationPreview');
        if (!startVal || !endVal) {
            display.innerText = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤';
            return;
        }
        const startDate = new Date(startVal);
        const endDate = new Date(endVal);
        startDate.setHours(0,0,0,0);
        endDate.setHours(0,0,0,0);
        if (endDate <= startDate) {
            display.innerHTML = '<span class="text-red-500 text-sm sm:text-base">‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</span>';
            return;
        }
        const diffTime = Math.abs(endDate - startDate);
        let totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        if (includeDay) totalDays += 1;
        const weeks = Math.floor(totalDays / 7);
        const remainingDays = totalDays % 7;
        let weekText = weeks > 0 ? `(${weeks} ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå${remainingDays > 0 ? ' ' + remainingDays + ' ‡∏ß‡∏±‡∏ô' : ''})` : `(‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 1 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå)`;
        display.innerHTML = `‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ <span class="font-bold text-lg sm:text-xl">${totalDays}</span> ‡∏ß‡∏±‡∏ô <span class="text-xs sm:text-sm text-gray-500 font-normal">${weekText}</span>`;
    }

    function calculateMeds() {
        const startVal = document.getElementById('startDate').value;
        const endVal = document.getElementById('endDate').value;
        const includeDay = document.getElementById('includeEndDate').checked;
        const resultArea = document.getElementById('resultArea');

        if (!startVal || !endVal) { 
            resultArea.classList.add('hidden');
            return; 
        }
        
        const startDate = new Date(startVal);
        const endDate = new Date(endVal);
        startDate.setHours(0,0,0,0);
        endDate.setHours(0,0,0,0);
        
        if (endDate <= startDate) { 
            resultArea.classList.add('hidden');
            return; 
        }

        const dosageMap = {};
        daysOfWeek.forEach(day => { 
            dosageMap[day.id] = parseDosage(selectedDosages[day.id]); 
        });
        
        let totalPills = 0; let dayCount = 0; let currentDate = new Date(startDate);
        const targetDate = new Date(endDate);
        if (includeDay) targetDate.setDate(targetDate.getDate() + 1);
        
        while (currentDate < targetDate) {
            totalPills += dosageMap[currentDate.getDay()];
            dayCount++;
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        resultArea.classList.remove('hidden');
        document.getElementById('totalPills').innerText = totalPills % 1 === 0 ? totalPills : totalPills.toFixed(2);
        const weeks = Math.floor(dayCount / 7);
        const remDays = dayCount % 7;
        document.getElementById('durationText').innerText = `‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ${dayCount} ‡∏ß‡∏±‡∏ô ${weeks > 0 ? `(${weeks} ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ${remDays} ‡∏ß‡∏±‡∏ô)` : ''} ${includeDay ? '(‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î)' : '(‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î)'}`;

        clearTimeout(forwardSaveTimeout);
        forwardSaveTimeout = setTimeout(saveForwardHistory, AUTO_SAVE_DELAY);
    }

    function resetForward() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').value = today;
        document.getElementById('endDate').value = "";
        document.getElementById('includeEndDate').checked = false;
        document.getElementById('durationPreview').innerText = "";
        document.getElementById('resultArea').classList.add('hidden');
        
        // Reset selected dosages to "-"
        Object.keys(selectedDosages).forEach(key => {
            selectedDosages[key] = "-";
        });
        activeEditDay = null; // ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà
        renderDayList(); 
        renderSharedOptions();
    }

    function resetReverse() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('reverseStartDate').value = today;
        document.getElementById('reversePillsInput').value = "";
        document.getElementById('reverseResultBody').innerHTML = '<tr><td colspan="3" class="p-6 sm:p-8 text-center text-gray-400 text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</td></tr>';
        
        document.getElementById('customPerDose').value = 1;
        document.getElementById('customTimes').value = 1;
        document.getElementById('customFreq').value = "daily";
        toggleWeekDays();
        document.getElementById('customResult').classList.add('hidden');
    }

    // --- PART 2: Reverse Calculation Logic ---
    function calculateAllReverse() {
        calculateReverseTable();
        calculateCustom();
    }

    function calculateReverseTable() {
        const pills = parseFloat(document.getElementById('reversePillsInput').value);
        const startDateVal = document.getElementById('reverseStartDate').value;
        const tbody = document.getElementById('reverseResultBody');
        
        if (!pills || pills <= 0 || !startDateVal) {
            tbody.innerHTML = '<tr><td colspan="3" class="p-6 sm:p-8 text-center text-gray-400 text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</td></tr>';
            return;
        }

        const startDate = new Date(startDateVal);
        startDate.setHours(0,0,0,0);

        const presets = [
            { label: "1 x 1", daily: 1 }, { label: "1 x 2", daily: 2 }, { label: "1 x 3", daily: 3 }, { label: "1 x 4", daily: 4 }, { label: "1 x 1 EOD (‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏±‡∏ô)", daily: 0.5 },
            { label: "1/2 x 1", daily: 0.5 }, { label: "1/2 x 2", daily: 1 }, { label: "1/2 x 3", daily: 1.5 }, { label: "1/2 x 4", daily: 2 }, { label: "1/2 x 1 EOD (‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏±‡∏ô)", daily: 0.25 },
            { label: "2 x 1", daily: 2 }, { label: "2 x 2", daily: 4 }, { label: "2 x 3", daily: 6 }, { label: "2 x 4", daily: 8 },
            { label: "3/4 x 1", daily: 0.75 }, { label: "3/4 x 2", daily: 1.5 }, { label: "3/4 x 3", daily: 2.25 }, { label: "3/4 x 4", daily: 3 }, { label: "3/4 x 1 EOD (‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏±‡∏ô)", daily: 0.375 },
            { label: "1 tab Once-Weekly", daily: 1/7 }, { label: "1 tab Twice Weekly", daily: 2/7 }, { label: "2 tab Once-Weekly", daily: 2/7 }, { label: "2 tab Twice Weekly", daily: 4/7 },
            { label: "3 x 1", daily: 3 }, { label: "3 x 2", daily: 6 }, { label: "3 x 3", daily: 9 }, { label: "3 x 4", daily: 12 }, { label: "3 x 1 EOD (‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏±‡∏ô)", daily: 1.5 },
        ];

        let html = '';
        presets.forEach(p => {
            const totalDaysRaw = pills / p.daily;
            const isExact = Number.isInteger(totalDaysRaw) || Math.abs(totalDaysRaw - Math.round(totalDaysRaw)) < 0.01;
            const roundDays = Math.floor(totalDaysRaw);
            const weeks = (totalDaysRaw / 7).toFixed(1);
            
            const displayDays = isExact ? roundDays : `~${roundDays}`;
            const detailText = isExact ? '' : `<span class="text-[10px] sm:text-xs text-gray-400 block mt-0.5 sm:mt-1">(${totalDaysRaw.toFixed(2)})</span>`;
            const weekText = `<span class="text-[10px] sm:text-xs text-gray-500 block mt-0.5 sm:mt-1">${weeks} ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</span>`;

            const targetDate = new Date(startDate);
            targetDate.setDate(targetDate.getDate() + (roundDays - 1));
            const formattedDate = `${targetDate.getDate()}/${targetDate.getMonth()+1}/${targetDate.getFullYear()}`;

            html += `
                <tr class="hover:bg-yellow-50 transition-colors">
                    <td class="p-2 sm:p-3 text-xs sm:text-sm font-medium text-gray-700 border-b border-gray-100">${p.label}</td>
                    <td class="p-2 sm:p-3 text-center border-b border-gray-100">
                        <span class="font-bold text-yellow-700 text-sm sm:text-lg">${displayDays}</span>
                        ${detailText}
                        ${weekText}
                    </td>
                    <td class="p-2 sm:p-3 text-center border-b border-gray-100">
                         <span class="font-bold text-yellow-900 bg-yellow-100 px-1.5 sm:px-2 py-0.5 sm:py-1 rounded text-xs sm:text-sm">${formattedDate}</span>
                    </td>
                </tr>
            `;
        });
        tbody.innerHTML = html;
    }

    function renderWeekDaysSelector() {
        const container = document.querySelector('#weekDaysSelector .flex');
        const shortDays = ["‡∏≠‡∏≤", "‡∏à", "‡∏≠", "‡∏û", "‡∏û‡∏§", "‡∏®", "‡∏™"];
        let html = '';
        shortDays.forEach((day, index) => {
            html += `<div>
                    <input type="checkbox" id="customDay-${index}" class="day-checkbox hidden" value="${index}" onchange="calculateCustom()">
                    <label for="customDay-${index}" class="block w-8 h-8 sm:w-10 sm:h-10 leading-8 sm:leading-10 text-center rounded-full border border-gray-300 text-gray-600 bg-white cursor-pointer hover:bg-gray-50 transition-colors select-none text-xs sm:text-sm font-bold">${day}</label>
                </div>`;
        });
        container.innerHTML = html;
    }

    function toggleWeekDays() {
        const freq = document.getElementById('customFreq').value;
        const selector = document.getElementById('weekDaysSelector');
        if (freq === 'specific') {
            selector.classList.remove('hidden');
        } else {
            selector.classList.add('hidden');
        }
    }

    function validateDosageInput(input) {
        let value = parseFloat(input.value);
        if (isNaN(value) || value <= 0) {
            value = 0.25;
        } else {
            value = Math.round(value * 4) / 4;
            if (value < 0.25) value = 0.25;
        }
        input.value = value;
        calculateCustom();
    }

    function calculateCustom() {
        const resultDiv = document.getElementById('customResult');
        const totalPills = parseFloat(document.getElementById('reversePillsInput').value);
        const startDateVal = document.getElementById('reverseStartDate').value;

        if (!totalPills || totalPills <= 0 || !startDateVal) {
            resultDiv.classList.add('hidden');
            return;
        }

        const perDose = parseFloat(document.getElementById('customPerDose').value);
        const times = parseFloat(document.getElementById('customTimes').value);
        const freq = document.getElementById('customFreq').value;
        
        if (!perDose || !times) return;

        let remainingPills = totalPills;
        let currentDate = new Date(startDateVal);
        currentDate.setHours(0,0,0,0);
        let daysPassed = 0;
        let dailyDose = perDose * times;
        let lastDoseDate = null;
        const maxLoop = 10000;
        let loopCount = 0;

        let selectedDays = [];
        if (freq === 'specific') {
            document.querySelectorAll('.day-checkbox:checked').forEach(cb => selectedDays.push(parseInt(cb.value)));
            if (selectedDays.length === 0) {
                document.getElementById('customEndDate').innerText = "‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô";
                resultDiv.classList.remove('hidden');
                return;
            }
        }

        while (remainingPills >= 0 && loopCount < maxLoop) {
            let consume = false;
            if (freq === 'daily') consume = true;
            else if (freq === 'eod') { if (daysPassed % 2 === 0) consume = true; }
            else if (freq === 'specific') { if (selectedDays.includes(currentDate.getDay())) consume = true; }

            if (consume) {
                if (remainingPills >= dailyDose) {
                    remainingPills -= dailyDose;
                    lastDoseDate = new Date(currentDate);
                } else { break; }
            }
            
            currentDate.setDate(currentDate.getDate() + 1);
            daysPassed++;
            loopCount++;
        }
        
        const day = currentDate.getDate();
        const month = currentDate.getMonth() + 1;
        const year = currentDate.getFullYear();
        const formattedDate = `${day}/${month}/${year}`;
        
        let lastDoseStr = "-";
        let lastDoseDurationStr = "";
        
        if (lastDoseDate) {
             const ld = lastDoseDate.getDate();
             const lm = lastDoseDate.getMonth() + 1;
             const ly = lastDoseDate.getFullYear();
             lastDoseStr = `${ld}/${lm}/${ly}`;
             const startD = new Date(startDateVal);
             startD.setHours(0,0,0,0);
             const diffTime = lastDoseDate - startD;
             const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
             lastDoseDurationStr = `(‡∏ó‡∏≤‡∏ô‡πÑ‡∏î‡πâ ${diffDays} ‡∏ß‡∏±‡∏ô)`;
        }

        const totalDaysAppt = daysPassed + 1;
        const apptDurationStr = `(‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á ${totalDaysAppt} ‡∏ß‡∏±‡∏ô)`;

        document.getElementById('customEndDate').innerText = formattedDate;
        document.getElementById('customLastDoseDate').innerText = lastDoseStr;
        document.getElementById('durationToLastDose').innerText = lastDoseDurationStr;
        document.getElementById('durationToAppointment').innerHTML = apptDurationStr;
        resultDiv.classList.remove('hidden');
    }

    // --- History Functions ---
    function triggerSaveEffect(statusId) {
        const el = document.getElementById(statusId);
        if(!el) return;
        el.classList.remove('saving-active');
        void el.offsetWidth; // trigger reflow
        el.classList.add('saving-active');
    }

    function saveForwardHistory() {
        const startVal = document.getElementById('startDate').value;
        const endVal = document.getElementById('endDate').value;
        const includeDay = document.getElementById('includeEndDate').checked;
        if (!startVal || !endVal) return;
        
        const startDate = new Date(startVal);
        const endDate = new Date(endVal);
        startDate.setHours(0,0,0,0);
        endDate.setHours(0,0,0,0);
        const diffTime = Math.abs(endDate - startDate);
        let totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        if (includeDay) totalDays += 1;

        const item = {
            id: Date.now(),
            type: 'calc_meds',
            label: '‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤',
            detail: `‡πÄ‡∏£‡∏¥‡πà‡∏° ${formatDateTH(startVal)} ‡∏ñ‡∏∂‡∏á ${formatDateTH(endVal)}`,
            result: `${totalDays} ‡∏ß‡∏±‡∏ô`,
            timestamp: new Date().toLocaleDateString('th-TH', { hour: '2-digit', minute: '2-digit' })
        };
        addHistoryItem(item);
        triggerSaveEffect('saveStatus1');
    }

    function addHistoryItem(item) {
        let history = JSON.parse(localStorage.getItem('medCalcHistory') || '[]');
        if (history.length > 0) {
            const lastItem = history[0];
            if (lastItem.type === item.type && lastItem.detail === item.detail && lastItem.result === item.result) return; 
        }
        history.unshift(item);
        if (history.length > 7) history = history.slice(0, 7);
        localStorage.setItem('medCalcHistory', JSON.stringify(history));
        loadHistory();
    }

    function loadHistory() {
        const list = document.getElementById('historyList');
        const history = JSON.parse(localStorage.getItem('medCalcHistory') || '[]');
        if (history.length === 0) {
            list.innerHTML = '<li class="text-center text-gray-400 text-xs sm:text-sm py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</li>';
            return;
        }
        let html = '';
        history.forEach(item => {
            const iconClass = item.type === 'calc_meds' ? 'text-blue-500 fa-clock' : 'text-indigo-500 fa-calendar-alt';
            const bgClass = item.type === 'calc_meds' ? 'bg-blue-50' : 'bg-indigo-50';
            html += `
                <li class="bg-white p-2.5 sm:p-3 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center animate-fade-in">
                    <div class="flex items-start gap-2.5 sm:gap-3">
                        <div class="${bgClass} p-1.5 sm:p-2 rounded-full w-7 h-7 sm:w-8 sm:h-8 flex items-center justify-center shrink-0"><i class="fas ${iconClass} text-xs sm:text-base"></i></div>
                        <div>
                            <div class="font-bold text-gray-700 text-xs sm:text-sm">${item.result}</div>
                            <div class="text-[10px] sm:text-xs text-gray-500">${item.detail}</div>
                        </div>
                    </div>
                    <div class="text-[10px] sm:text-xs text-gray-400 text-right"><div>${item.timestamp}</div></div>
                </li>`;
        });
        list.innerHTML = html;
    }

    function toggleModal() {
        const body = document.querySelector('body');
        const modal = document.querySelector('#clearHistoryModal');
        modal.classList.toggle('opacity-0');
        modal.classList.toggle('pointer-events-none');
        body.classList.toggle('modal-active');
    }

    function performClearHistory() {
        localStorage.removeItem('medCalcHistory');
        loadHistory();
        toggleModal();
    }

    function formatDateTH(dateStr) {
        if (!dateStr) return '-';
        const d = new Date(dateStr);
        return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()+543}`;
    }
</script>

</body>
</html>